<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ карта</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 800px; }
        #polygon-form {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }
        .edit-form {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1001;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .edit-form input, .edit-form button {
            margin: 5px 0;
            width: 100%;
        }
        .popup-button {
            margin-top: 5px;
            width: 100%;
        }
        .custom-cursor {
            cursor: url('/media/cross.svg') 7 7, auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="polygon-form" style="display: none;">
        <input type="text" id="short-description" placeholder="Краткое описание">
        <input type="text" id="description" placeholder="Полное описание">
        <button id="save-polygon">Сохранить полигон</button>
        <button id="cancel-polygon">Отмена</button>
    </div>
    <div id="edit-form" class="edit-form">
        <input type="text" id="edit-short-description" placeholder="Краткое описание">
        <input type="text" id="edit-description" placeholder="Полное описание">
        <button id="save-edit">Сохранить изменения</button>
        <button id="cancel-edit">Отмена</button>
    </div>
    <button id="add-polygon">Добавить полигон</button>
    <button id="prev-floor">Предыдущий этаж</button>
    <button id="next-floor">Следующий этаж</button>
    <script>
        var southWest = L.latLng(55.761147, 37.675767);
        var northEast = L.latLng(55.770116, 37.694542);
        var bounds = L.latLngBounds(southWest, northEast);
        const buildingCoords = [55.765927, 37.684929];

        var map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0,
            minZoom: 18,
            maxZoom: 21,
        }).setView(buildingCoords, 18);

        L.tileLayer('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQMAAABmvDolAAAAA1BMVEX///+nxBvIAAAAH0lEQVQYGe3BAQ0AAADCIPunNsc3YAAAAAAAAAAAAHwDcqdZAAAB70lEQVR4XnXQMW5kMQxE0Z+SlOUl5LLk0lLSCjnr5jFo+28wgHkPJKp4ATeSWOK/+68UZyxEkjN1Zkb6MDN1ZiyZJBdmJqllJrkVSTIzkuTCJLkwSS5MkguT5MIkuTBJLkySC5PkwiS5MEkuTJILk+TCJPnA5Gg/YXe8h93xEnbHW9gdb2H3Pnl8h935Enbnc9i9L2F3Pjjew+7+H9uVvTnuw+68D7vzPuzOu7A7b8LuQ9g95c0dL2H3fgu7HNr7JezO+7A7H8LuBYe2f/gL2/+CXeHW9g9/Ybsf2O4HtvuB7X5gux/Y7ge2+4HtfmC7H9juB7b7ge1+YLsf2O4HtvuB7X5gux/Y7v0UdojTH/7C9tnuB7b7ge1+YLsf2O4HtvuB7X5gux/Y7ge2+4HtfmC7H9juB7b7ge1+YLsf2O4HtvuB7X5g+75kO7Q3x1vYvZ/C7vkSdu/nsHs+h937IezOx7B7P4Xd+RB2OTj+wvYp7P4HoLEMpgjCScoAAAAASUVORK5CYII=', {
            attribution: ''
        }).addTo(map);

        let currentFloor = {{ initial_floor }};
        const totalFloors = {{ total_floors }};
        let currentFloorLayer;
        let polygonLayers = [];
        let drawingPolygon = false;
        let currentPolygon = [];
        let tempPolygonLayer;
        let editingPolygonId = null;

        async function loadPolygons(floor) {
            polygonLayers.forEach(layer => map.removeLayer(layer));
            polygonLayers = [];

            if (currentFloorLayer) {
                map.removeLayer(currentFloorLayer);
            }

            const response = await fetch(`/get_polygons/${floor}/`);
            if (!response.ok) {
                console.error('Ошибка при загрузке данных этажа');
                return;
            }
            const data = await response.json();

            const bounds = [
                [55.764925, 37.682805],
                [55.766917, 37.68714]
            ];
            currentFloorLayer = L.imageOverlay(`/media/fk/${data.svg_path}`, bounds, {
                opacity: 1
            }).addTo(map);

            data.polygons.forEach(polygon => {
                const coordinates = JSON.parse(polygon.coordinates);
                const layer = L.polygon(coordinates, {
                    color: 'black',
                    weight: 1,
                    fillColor: 'blue',
                    fillOpacity: 0.1
                }).bindPopup(`
                    <strong>${polygon.short_description}</strong><br>
                    ${polygon.description}<br>
                    <button class="edit-polygon popup-button" data-id="${polygon.id}">Редактировать</button>
                    <button class="delete-polygon popup-button" data-id="${polygon.id}">Удалить</button>
                `);
                layer.addTo(map);
                polygonLayers.push(layer);

                layer.on('popupopen', function() {
                    document.querySelector('.edit-polygon').addEventListener('click', function() {
                        editingPolygonId = this.getAttribute('data-id');
                        document.getElementById('edit-short-description').value = polygon.short_description;
                        document.getElementById('edit-description').value = polygon.description;
                        document.getElementById('edit-form').style.display = 'block';
                    });
                    document.querySelector('.delete-polygon').addEventListener('click', function() {
                        if (confirm('Вы уверены, что хотите удалить этот полигон?')) {
                            deletePolygon(this.getAttribute('data-id'));
                        }
                    });
                });
            });
        }

        loadPolygons(currentFloor);

        document.getElementById('prev-floor').addEventListener('click', () => {
            currentFloor = (currentFloor - 1 + totalFloors) % totalFloors || totalFloors;
            loadPolygons(currentFloor);
        });

        document.getElementById('next-floor').addEventListener('click', () => {
            currentFloor = (currentFloor % totalFloors) + 1;
            loadPolygons(currentFloor);
        });

        document.getElementById('add-polygon').addEventListener('click', () => {
            drawingPolygon = true;
            currentPolygon = [];
            document.getElementById('polygon-form').style.display = 'block';
            map.on('click', onMapClick);
        });

        function onMapClick(e) {
            if (drawingPolygon) {
                currentPolygon.push([e.latlng.lat, e.latlng.lng]);
                if (tempPolygonLayer) {
                    map.removeLayer(tempPolygonLayer);
                }
                tempPolygonLayer = L.polygon(currentPolygon, {color: 'red'}).addTo(map);
            }
        }

        document.getElementById('save-polygon').addEventListener('click', async () => {
            if (currentPolygon.length < 3) {
                alert('Полигон должен иметь как минимум 3 точки');
                return;
            }

            const shortDescription = document.getElementById('short-description').value;
            const description = document.getElementById('description').value;

            const response = await fetch('/add_polygon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    floor: currentFloor,
                    short_description: shortDescription,
                    description: description,
                    coordinates: currentPolygon
                })
            });

            if (response.ok) {
                alert('Полигон успешно добавлен');
                resetPolygonDrawing();
                loadPolygons(currentFloor);
            } else {
                alert('Ошибка при сохранении полигона');
            }
        });

        document.getElementById('cancel-polygon').addEventListener('click', resetPolygonDrawing);

        function resetPolygonDrawing() {
            drawingPolygon = false;
            currentPolygon = [];
            if (tempPolygonLayer) {
                map.removeLayer(tempPolygonLayer);
            }
            document.getElementById('polygon-form').style.display = 'none';
            map.off('click', onMapClick);
            document.getElementById('short-description').value = '';
            document.getElementById('description').value = '';
        }

        document.getElementById('save-edit').addEventListener('click', async () => {
            const shortDescription = document.getElementById('edit-short-description').value;
            const description = document.getElementById('edit-description').value;

            const response = await fetch('/edit_polygon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: editingPolygonId,
                    short_description: shortDescription,
                    description: description
                })
            });

            if (response.ok) {
                alert('Полигон успешно отредактирован');
                document.getElementById('edit-form').style.display = 'none';
                loadPolygons(currentFloor);
            } else {
                alert('Ошибка при редактировании полигона');
            }
        });

        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('edit-form').style.display = 'none';
        });

        async function deletePolygon(id) {
            const response = await fetch('/delete_polygon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: id })
            });

            if (response.ok) {
                alert('Полигон успешно удален');
                loadPolygons(currentFloor);
            } else {
                alert('Ошибка при удалении полигона');
            }
        }
        // Код для пользовательского курсора
        const customCursorBtn = document.getElementById('add-polygon');
        const disableCursorBtn1 = document.getElementById('save-polygon');
        const disableCursorBtn2 = document.getElementById('cancel-polygon');
        const mapElement = document.getElementById('map');
        let isCustomCursorActive = false;

        function updateCursorState(active) {
            isCustomCursorActive = active;
            if (isCustomCursorActive) {
                mapElement.classList.add('custom-cursor');
            } else {
                mapElement.classList.remove('custom-cursor');
            }
        }

        customCursorBtn.addEventListener('click', () => {
            updateCursorState(!isCustomCursorActive);
        });

        disableCursorBtn1.addEventListener('click', () => {
            updateCursorState(false);
        });

        disableCursorBtn2.addEventListener('click', () => {
            updateCursorState(false);
        });
    </script>
</body>
</html>